

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyconform.flownodes &mdash; PyConform 0.3.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> PyConform
          

          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">PyConform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyconform.html">The PyConform Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">PyConform ChangeLog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">Product License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyConform</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyconform.flownodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyconform.flownodes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Data Flow Node Classes and Functions</span>

<span class="sd">This module contains the classes and functions needed to define nodes in Data Flows.</span>

<span class="sd">Copyright 2017-2020, University Corporation for Atmospheric Research</span>
<span class="sd">LICENSE: See the LICENSE.rst file for details</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">makedirs</span><span class="p">,</span> <span class="n">rename</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">cf_units</span> <span class="kn">import</span> <span class="n">Unit</span><span class="p">,</span> <span class="n">num2date</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="kn">from</span> <span class="nn">pyconform.datasets</span> <span class="kn">import</span> <span class="n">FileDesc</span><span class="p">,</span> <span class="n">VariableDesc</span>
<span class="kn">from</span> <span class="nn">pyconform.functions</span> <span class="kn">import</span> <span class="n">Function</span>
<span class="kn">from</span> <span class="nn">pyconform.indexing</span> <span class="kn">import</span> <span class="n">align_index</span><span class="p">,</span> <span class="n">index_str</span><span class="p">,</span> <span class="n">index_tuple</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">pyconform.physarray</span> <span class="kn">import</span> <span class="n">CharArray</span><span class="p">,</span> <span class="n">PhysArray</span>


<div class="viewcode-block" id="ValidationWarning"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.ValidationWarning">[docs]</a><span class="k">class</span> <span class="nc">ValidationWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Warning for validation errors&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="UnitsWarning"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.UnitsWarning">[docs]</a><span class="k">class</span> <span class="nc">UnitsWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Warning for units errors&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DateTimeAutoParseWarning"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.DateTimeAutoParseWarning">[docs]</a><span class="k">class</span> <span class="nc">DateTimeAutoParseWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Warning for not being able to autoparse new filename based on date-time in the file&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="iter_dfs"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.iter_dfs">[docs]</a><span class="k">def</span> <span class="nf">iter_dfs</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterate through graph of FlowNodes from a starting node using a Depth-First Search</span>

<span class="sd">    Parameters:</span>
<span class="sd">        node (FlowNode): the starting node from where to begin iterating</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FlowNode</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can only iterate over FlowNodes&quot;</span><span class="p">)</span>

    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">tosearch</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">tosearch</span><span class="p">:</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">tosearch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">FlowNode</span><span class="p">):</span>
            <span class="n">tosearch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nd</span><span class="o">.</span><span class="n">inputs</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">nd</span></div>


<div class="viewcode-block" id="iter_bfs"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.iter_bfs">[docs]</a><span class="k">def</span> <span class="nf">iter_bfs</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterate through graph of FlowNodes from a starting node using a Breadth-First Search</span>

<span class="sd">    Parameters:</span>
<span class="sd">        node (FlowNode): the starting node from where to begin iterating</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">FlowNode</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can only iterate over FlowNodes&quot;</span><span class="p">)</span>

    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">tosearch</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">tosearch</span><span class="p">:</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">tosearch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">FlowNode</span><span class="p">):</span>
            <span class="n">tosearch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nd</span><span class="o">.</span><span class="n">inputs</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">nd</span></div>


<div class="viewcode-block" id="FlowNode"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.FlowNode">[docs]</a><span class="k">class</span> <span class="nc">FlowNode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class for objects that can appear in a data flow</span>

<span class="sd">    The FlowNode object represents a point in the directed acyclic graph where multiple</span>
<span class="sd">    edges meet.  It represents a functional operation on the DataArrays coming into it from</span>
<span class="sd">    its adjacent DataNodes.  The FlowNode itself outputs the result of this operation</span>
<span class="sd">    through the __getitem__ interface (i.e., FlowNode[item]), returning a slice of a</span>
<span class="sd">    PhysArray.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer</span>

<span class="sd">        Parameters:</span>
<span class="sd">            label: A label to give the FlowNode</span>
<span class="sd">            inputs (list): DataNodes that provide input into this FlowNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The FlowNode&#39;s label&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inputs into this FlowNode&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span></div>


<div class="viewcode-block" id="DataNode"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.DataNode">[docs]</a><span class="k">class</span> <span class="nc">DataNode</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FlowNode class to create data in memory</span>

<span class="sd">    This is a &quot;source&quot; FlowNode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer</span>

<span class="sd">        Parameters:</span>
<span class="sd">            data (PhysArray): Data to store in this FlowNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine type and upcast, if necessary</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">PhysArray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># Store data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">array</span>

        <span class="c1"># Call base class initializer</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and retrieve the data associated with this FlowNode operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>


<div class="viewcode-block" id="ReadNode"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.ReadNode">[docs]</a><span class="k">class</span> <span class="nc">ReadNode</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FlowNode class for reading data from a NetCDF file</span>

<span class="sd">    This is a &quot;source&quot; FlowNode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer</span>

<span class="sd">        Parameters:</span>
<span class="sd">            variable (VariableDesc): A variable descriptor object</span>
<span class="sd">            index (tuple, slice, int, dict): A tuple of slices or ints, or a slice or int,</span>
<span class="sd">                specifying the range of data to read from the file (in file-local indices)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check variable descriptor type and existence in the file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">VariableDesc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Unrecognized variable descriptor of type &quot;</span>
                <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">variable</span><span class="p">),</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Check for associated file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Variable descriptor </span><span class="si">{}</span><span class="s2"> has no associated files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fdesc</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fdesc</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span> <span class="o">=</span> <span class="n">fdesc</span><span class="o">.</span><span class="n">name</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                <span class="s2">&quot;File path not found for input variable: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Check that the variable exists in the file</span>
        <span class="k">with</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s2">&quot;Variable </span><span class="si">{!r}</span><span class="s2"> not found in NetCDF file: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variable</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Check if the index means &quot;all&quot;</span>
        <span class="n">is_all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">is_all</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">):</span>
            <span class="n">is_all</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">is_all</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Store the reading index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>

        <span class="c1"># Call the base class initializer</span>
        <span class="k">if</span> <span class="n">is_all</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">index_str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ReadNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read PhysArray from file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ncfile</span><span class="p">:</span>

            <span class="c1"># Get a reference to the variable</span>
            <span class="n">ncvar</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_variable</span><span class="p">]</span>

            <span class="c1"># Get the attributes into a dictionary, for convenience</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">ncvar</span><span class="o">.</span><span class="n">getncattr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ncvar</span><span class="o">.</span><span class="n">ncattrs</span><span class="p">()}</span>

            <span class="c1"># Read the variable units</span>
            <span class="n">units_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">calendar_attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calendar&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">units_attr</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="n">calendar_attr</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Units </span><span class="si">{!r}</span><span class="s2"> unrecognized in UDUNITS.  Assuming unitless.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">units_attr</span>
                <span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">UnitsWarning</span><span class="p">)</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>

            <span class="c1"># Read the original variable dimensions</span>
            <span class="n">dimensions0</span> <span class="o">=</span> <span class="n">ncvar</span><span class="o">.</span><span class="n">dimensions</span>

            <span class="c1"># Read the original variable shape</span>
            <span class="n">shape0</span> <span class="o">=</span> <span class="n">ncvar</span><span class="o">.</span><span class="n">shape</span>

            <span class="c1"># Align the read-indices on dimensions</span>
            <span class="n">index1</span> <span class="o">=</span> <span class="n">align_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">,</span> <span class="n">dimensions0</span><span class="p">)</span>

            <span class="c1"># Get the dimensions after application of the first index</span>
            <span class="n">dimensions1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dimensions0</span><span class="p">,</span> <span class="n">index1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Align the second index on the intermediate dimensions</span>
            <span class="n">index2</span> <span class="o">=</span> <span class="n">align_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">dimensions1</span><span class="p">)</span>

            <span class="c1"># Get the dimensions after application of the second index</span>
            <span class="n">dimensions2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dimensions1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Compute the joined index object</span>
            <span class="n">index12</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">ncvar</span><span class="p">[</span><span class="n">index12</span><span class="p">]</span>

            <span class="c1"># Upconvert, if possible</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ncvar</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ncvar</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="c1"># Read the positive attribute, if available</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;positive&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PhysArray</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions2</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="n">pos</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EvalNode"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.EvalNode">[docs]</a><span class="k">class</span> <span class="nc">EvalNode</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FlowNode class for evaluating a function on input from neighboring DataNodes</span>

<span class="sd">    The EvalNode is constructed with a function reference and any number of arguments to</span>
<span class="sd">    that function.  The number of arguments supplied must match the number of arguments accepted</span>
<span class="sd">    by the function.  The arguments can be any type, and the order of the arguments will be</span>
<span class="sd">    preserved in the call signature of the function.  If the arguments are of type FlowNode,</span>
<span class="sd">    then a reference to the FlowNode will be stored.  If the arguments are of any other type, the</span>
<span class="sd">    argument will be stored by the EvalNode.</span>

<span class="sd">    This is a &quot;non-source&quot;/&quot;non-sink&quot; FlowNode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer</span>

<span class="sd">        Parameters:</span>
<span class="sd">            label: A label to give the FlowNode</span>
<span class="sd">            func (class): A Function class</span>
<span class="sd">            args (list): Arguments to the function given by &#39;func&#39;</span>
<span class="sd">            kwds (dict): Keyword arguments to the function given by &#39;func&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize the function object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

        <span class="c1"># Include all references as input</span>
        <span class="n">allargs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">)</span>

        <span class="c1"># Call the base class initialization</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EvalNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="n">allargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sumlike_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the set of sum-like dimensions registered by the node&#39;s function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="o">.</span><span class="n">sumlike_dimensions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and retrieve the data associated with this FlowNode operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>


<div class="viewcode-block" id="MapNode"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.MapNode">[docs]</a><span class="k">class</span> <span class="nc">MapNode</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FlowNode class to map input data from a neighboring FlowNode to new dimension names and units</span>

<span class="sd">    The MapNode can rename the dimensions of a FlowNode&#39;s output data.  It does not change the</span>
<span class="sd">    data itself, however.  The input dimension names will be changed according to the dimension</span>
<span class="sd">    map given.  If an input dimension name is not referenced by the map, then the input dimension</span>
<span class="sd">    name does not change.</span>

<span class="sd">    This is a &quot;non-source&quot;/&quot;non-sink&quot; FlowNode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">dnode</span><span class="p">,</span> <span class="n">dmap</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer</span>

<span class="sd">        Parameters:</span>
<span class="sd">            label: The label given to the FlowNode</span>
<span class="sd">            dnode (FlowNode): FlowNode that provides input into this FlowNode</span>
<span class="sd">            dmap (dict): A dictionary mapping dimension names of the input data to</span>
<span class="sd">                new dimensions names for the output variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check FlowNode type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dnode</span><span class="p">,</span> <span class="n">FlowNode</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;MapNode can only act on output from another FlowNode&quot;</span><span class="p">)</span>

        <span class="c1"># Check dimension map type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmap</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Dimension map must be a dictionary&quot;</span><span class="p">)</span>

        <span class="c1"># Store the dimension input-to-output map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i2omap</span> <span class="o">=</span> <span class="n">dmap</span>

        <span class="c1"># Construct the reverse mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_o2imap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dmap</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="c1"># Call base class initializer</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MapNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">dnode</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and retrieve the data associated with this FlowNode operation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Request the input information without pulling data</span>
        <span class="n">inp_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Get the input data dimensions</span>
        <span class="n">inp_dims</span> <span class="o">=</span> <span class="n">inp_info</span><span class="o">.</span><span class="n">dimensions</span>

        <span class="c1"># The input/output dimensions will be the same</span>
        <span class="c1"># OR should be contained in the input-to-output dimension map</span>
        <span class="n">out_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i2omap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">inp_dims</span><span class="p">)</span>

        <span class="c1"># Compute the input index in terms of input dimensions</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inp_index</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">inp_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_o2imap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_index</span> <span class="o">=</span> <span class="n">index_tuple</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp_dims</span><span class="p">))</span>
            <span class="n">inp_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_o2imap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">out_dims</span><span class="p">,</span> <span class="n">out_index</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Return the mapped data</span>
        <span class="n">idims_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inp_dims</span><span class="p">)</span>
        <span class="n">odims_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dims</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inp_dims</span> <span class="o">==</span> <span class="n">out_dims</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">inp_info</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;map(</span><span class="si">{}</span><span class="s2">, from=[</span><span class="si">{}</span><span class="s2">], to=[</span><span class="si">{}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">inp_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">idims_str</span><span class="p">,</span> <span class="n">odims_str</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">PhysArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">inp_index</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">out_dims</span><span class="p">)</span></div>


<div class="viewcode-block" id="ValidateNode"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.ValidateNode">[docs]</a><span class="k">class</span> <span class="nc">ValidateNode</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FlowNode class to validate input data from a neighboring FlowNode</span>

<span class="sd">    The ValidateNode takes additional attributes in its initializer that can effect the</span>
<span class="sd">    behavior of its __getitem__ method.  The special attributes are:</span>

<span class="sd">        &#39;valid_min&#39;: The minimum value the data should have, if valid</span>
<span class="sd">        &#39;valid_max&#39;: The maximum value the data should have, if valid</span>
<span class="sd">        &#39;min_mean_abs&#39;: The minimum acceptable value of the mean of the absolute value of the data</span>
<span class="sd">        &#39;max_mean_abs&#39;: The maximum acceptable value of the mean of the absolute value of the data</span>

<span class="sd">    If these attributes are supplied to the ValidateNode at construction time, then the</span>
<span class="sd">    associated validation checks will be made on the data when __getitem__ is called.</span>

<span class="sd">    Additional attributes may be added to the ValidateNode that do not affect functionality.</span>
<span class="sd">    These attributes may be named however the user wishes and can be retrieved from the FlowNode</span>
<span class="sd">    as a dictionary with the &#39;attributes&#39; property.</span>

<span class="sd">    This is a &quot;non-source&quot;/&quot;non-sink&quot; FlowNode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vdesc</span><span class="p">,</span> <span class="n">dnode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer</span>

<span class="sd">        Parameters:</span>
<span class="sd">            vdesc (VariableDesc): A variable descriptor object for the output variable</span>
<span class="sd">            dnode (FlowNode): FlowNode that provides input into this FlowNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check Types</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdesc</span><span class="p">,</span> <span class="n">VariableDesc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ValidateNode requires a VariableDesc object as input&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dnode</span><span class="p">,</span> <span class="n">FlowNode</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ValidateNode can only act on output from another FlowNode&quot;</span><span class="p">)</span>

        <span class="c1"># Call base class initializer</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ValidateNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">vdesc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dnode</span><span class="p">)</span>

        <span class="c1"># Save the variable descriptor object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span> <span class="o">=</span> <span class="n">vdesc</span>

        <span class="c1"># Initialize the history attribute, if necessary</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">dnode</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;history&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;history&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Else inherit the units and calendar of the input data stream, if</span>
        <span class="c1"># necessary</span>
        <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">is_time_reference</span><span class="p">():</span>
                <span class="n">ustr</span><span class="p">,</span> <span class="n">rstr</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;since&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">units</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ustr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">units</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">refdatetime</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">refdatetime</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> since </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ustr</span><span class="p">,</span> <span class="n">rstr</span><span class="p">)</span>

                <span class="c1"># Calendars must match as convertion between different</span>
                <span class="c1"># calendars will fail</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">calendar</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">info</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;calendar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">units</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attributes dictionary of the variable returned by the ValidateNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">attributes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dimensions tuple of the variable returned by the ValidateNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and retrieve the data associated with this FlowNode operation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the data to validate</span>
        <span class="n">indata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Check datatype, and cast as necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">odtype</span> <span class="o">=</span> <span class="n">indata</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">odtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vdesc</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span><span class="n">indata</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">odtype</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s2">&quot;same_kind&quot;</span><span class="p">):</span>
            <span class="n">indata</span> <span class="o">=</span> <span class="n">indata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">odtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Cannot cast datatype </span><span class="si">{!s}</span><span class="s2"> to </span><span class="si">{!s}</span><span class="s2"> in ValidateNode &quot;</span> <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">indata</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">odtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Check that units match as expected, otherwise convert</span>
        <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">ounits</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">calendar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calendar&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ounits</span> <span class="o">!=</span> <span class="n">indata</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">indata</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">ounits</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">indata</span> <span class="o">=</span> <span class="n">indata</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">ounits</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;When validating output variable </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">err</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="c1"># Check that the dimensions match as expected</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">!=</span> <span class="n">indata</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="n">indata</span> <span class="o">=</span> <span class="n">indata</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>

        <span class="c1"># Check the positive attribute, if specified</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;positive&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indata</span><span class="o">.</span><span class="n">positive</span> <span class="o">!=</span> <span class="n">positive</span><span class="p">:</span>
            <span class="n">indata</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>

        <span class="c1"># Do not validate if index is None (nothing to validate)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">indata</span>

        <span class="c1"># Testing parameters</span>
        <span class="n">valid_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_min&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">valid_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ok_min_mean_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok_min_mean_abs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ok_max_mean_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok_max_mean_abs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Validate minimum</span>
        <span class="k">if</span> <span class="n">valid_min</span><span class="p">:</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dmin</span> <span class="o">&lt;</span> <span class="n">valid_min</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;valid_min: </span><span class="si">{}</span><span class="s2"> &lt; </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">valid_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ValidationWarning</span><span class="p">)</span>
                <span class="n">indata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">indata</span> <span class="o">&lt;=</span> <span class="n">valid_min</span><span class="p">,</span> <span class="n">indata</span><span class="p">)</span>

        <span class="c1"># Validate maximum</span>
        <span class="k">if</span> <span class="n">valid_max</span><span class="p">:</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dmax</span> <span class="o">&gt;</span> <span class="n">valid_max</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;valid_max: </span><span class="si">{}</span><span class="s2"> &gt; </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span> <span class="n">valid_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ValidationWarning</span><span class="p">)</span>
                <span class="n">indata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">indata</span> <span class="o">&gt;=</span> <span class="n">valid_max</span><span class="p">,</span> <span class="n">indata</span><span class="p">)</span>

        <span class="c1"># Compute mean of the absolute value, if necessary</span>
        <span class="k">if</span> <span class="n">ok_min_mean_abs</span> <span class="ow">or</span> <span class="n">ok_max_mean_abs</span><span class="p">:</span>
            <span class="n">mean_abs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">indata</span><span class="p">))</span>

        <span class="c1"># Validate minimum mean abs</span>
        <span class="k">if</span> <span class="n">ok_min_mean_abs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mean_abs</span> <span class="o">&lt;</span> <span class="n">ok_min_mean_abs</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ok_min_mean_abs: </span><span class="si">{}</span><span class="s2"> &lt; </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mean_abs</span><span class="p">,</span> <span class="n">ok_min_mean_abs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
                <span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ValidationWarning</span><span class="p">)</span>

        <span class="c1"># Validate maximum mean abs</span>
        <span class="k">if</span> <span class="n">ok_max_mean_abs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mean_abs</span> <span class="o">&gt;</span> <span class="n">ok_max_mean_abs</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ok_max_mean_abs: </span><span class="si">{}</span><span class="s2"> &gt; </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mean_abs</span><span class="p">,</span> <span class="n">ok_max_mean_abs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
                <span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ValidationWarning</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">indata</span></div>


<div class="viewcode-block" id="WriteNode"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.WriteNode">[docs]</a><span class="k">class</span> <span class="nc">WriteNode</span><span class="p">(</span><span class="n">FlowNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FlowNode that writes validated data to a file.</span>

<span class="sd">    This is a &quot;sink&quot; node, meaning that the __getitem__ (i.e., [index]) interface does not return</span>
<span class="sd">    anything.  Rather, the data &quot;retrieved&quot; through the __getitem__ interface is sent directly to</span>
<span class="sd">    file.</span>

<span class="sd">    For this reason, it is possible to &quot;retrieve&quot; data multiple times, resulting in writing and</span>
<span class="sd">    overwriting of data.  To eliminate this inefficiency, it is advised that you use the &#39;execute&#39;</span>
<span class="sd">    method to write data efficiently once (and only once).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filedesc</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filedesc (FileDesc): File descriptor for the file to write</span>
<span class="sd">            inputs (tuple): A tuple of ValidateNodes providing input into the file</span>
<span class="sd">            history (bool): Whether to write a history attribute generated during execution</span>
<span class="sd">                for each variable in the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filedesc</span><span class="p">,</span> <span class="n">FileDesc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;File descriptor must be of FileDesc type&quot;</span><span class="p">)</span>

        <span class="c1"># Check and store input variables nodes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;WriteNode </span><span class="si">{!r}</span><span class="s2"> inputs must be given as a list or &quot;</span> <span class="s2">&quot;tuple&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">filedesc</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">ValidateNode</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;WriteNode </span><span class="si">{!r}</span><span class="s2"> cannot accept input from type </span><span class="si">{}</span><span class="s2">, must be a &quot;</span>
                        <span class="s2">&quot;ValidateNode&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filedesc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">inp</span><span class="p">))</span>
                <span class="p">)</span>

        <span class="c1"># Extract hidden variables (names starting with &#39;_&#39;) from list of input nodes</span>
        <span class="n">hidden_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">hidden_labels</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hidden_labels</span><span class="p">]</span>

        <span class="c1"># Call base class (label is filename)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WriteNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filedesc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Store the file descriptor for use later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span> <span class="o">=</span> <span class="n">filedesc</span>

        <span class="c1"># Check that inputs are contained in the file descriptor</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;WriteNode </span><span class="si">{!r}</span><span class="s2"> takes input from variable </span><span class="si">{!r}</span><span class="s2"> that is not &quot;</span>
                        <span class="s2">&quot;contained in the described file&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filedesc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">inp</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Construct the proper filename</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autoparse_filename_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_ext</span> <span class="o">=</span> <span class="s2">&quot;.tmp.nc&quot;</span>

        <span class="c1"># Set the filehandle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize set of inverted dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Initialize set of unwritten attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unwritten_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_FillValue&quot;</span><span class="p">,</span> <span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_autoparse_filename_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if autoparsing the filename needs to be done</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname (str): The original name of the file</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The new name for the file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>

            <span class="n">possible_tvars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">possible_inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">autoparse_time_variable</span><span class="p">:</span>
                <span class="n">possible_tvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">autoparse_time_variable</span><span class="p">)</span>
                <span class="n">possible_inputs</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_inputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="n">vdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;time1&quot;</span><span class="p">,</span> <span class="s2">&quot;time2&quot;</span><span class="p">,</span> <span class="s2">&quot;time3&quot;</span><span class="p">):</span>
                        <span class="n">possible_tvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">vdesc</span><span class="o">.</span><span class="n">cfunits</span><span class="p">()</span><span class="o">.</span><span class="n">is_time_reference</span><span class="p">()</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdesc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="p">):</span>
                        <span class="n">possible_tvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="s2">&quot;standard_name&quot;</span> <span class="ow">in</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">attributes</span>
                        <span class="ow">and</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;standard_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span>
                    <span class="p">):</span>
                        <span class="n">possible_tvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s2">&quot;axis&quot;</span> <span class="ow">in</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
                        <span class="n">possible_tvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_tvars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not identify a time variable to autoparse filename </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">fname</span>
                <span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">DateTimeAutoParseWarning</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">fname</span>
            <span class="n">possible_tnodes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">vnode</span><span class="o">.</span><span class="n">label</span><span class="p">:</span> <span class="n">vnode</span>
                <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="n">possible_inputs</span>
                <span class="k">if</span> <span class="n">vnode</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">possible_tvars</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_tnodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Time variable input missing for file </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">tnode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">possible_tnodes</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">possible_tnodes</span>
                <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">possible_tnodes</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">t1</span> <span class="o">=</span> <span class="n">tnode</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">tnode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">while</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="n">beg</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="n">beg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Filename </span><span class="si">{!r}</span><span class="s2"> has unbalanced special characters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[:</span><span class="n">beg</span><span class="p">]</span>
                <span class="n">fmtstr1</span><span class="p">,</span> <span class="n">fmtstr2</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[</span><span class="n">beg</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>

                <span class="n">datestr1</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">num2date</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">units</span><span class="p">),</span> <span class="n">t1</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmtstr1</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">datestr2</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">num2date</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">units</span><span class="p">),</span> <span class="n">t2</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmtstr2</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">-</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">datestr1</span><span class="p">,</span> <span class="n">datestr2</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fname</span>

<div class="viewcode-block" id="WriteNode.enable_history"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.WriteNode.enable_history">[docs]</a>    <span class="k">def</span> <span class="nf">enable_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable writing of the history attribute to the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;history&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwritten_attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unwritten_attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;history&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WriteNode.disable_history"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.WriteNode.disable_history">[docs]</a>    <span class="k">def</span> <span class="nf">disable_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disable writing of the history attribute to the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unwritten_attributes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;history&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_open_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deflate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the file for writing, if not open already</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Make the necessary subdirectories to open the file</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
            <span class="n">tmp_fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_ext</span><span class="p">)</span>
            <span class="n">fdir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">format</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fdir</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">makedirs</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fdir</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;Already created directory for output file </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">fname</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                            <span class="s2">&quot;Failed to create directory for output file </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">fname</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

            <span class="c1"># Try to open the output file for writing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">tmp_fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Failed to open output file </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

            <span class="c1"># Write the global attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;creation_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">setncatts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>

            <span class="c1"># Scan over variables for coordinates and dimension information</span>
            <span class="n">req_dims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">.</span><span class="n">label</span>
                <span class="n">vdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>

                <span class="c1"># Get only dimension descriptors needed by the variables</span>
                <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="s2">&quot;Dimension </span><span class="si">{!r}</span><span class="s2"> needed by variable </span><span class="si">{!r}</span><span class="s2"> is not specified &quot;</span>
                                <span class="s2">&quot;in file </span><span class="si">{!r}</span><span class="s2">&quot;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="n">req_dims</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>

                <span class="c1"># Determine coordinates and dimensions to invert</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdesc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;axis&quot;</span> <span class="ow">in</span> <span class="n">vnode</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;direction&quot;</span> <span class="ow">in</span> <span class="n">vnode</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                        <span class="n">vdir_out</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">vdir_out</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;increasing&quot;</span><span class="p">,</span> <span class="s2">&quot;decreasing&quot;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="s2">&quot;Unrecognized direction in output coordinate variable &quot;</span>
                                    <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2"> when writing file </span><span class="si">{!r}</span><span class="s2">&quot;</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">vdir_inp</span> <span class="o">=</span> <span class="n">WriteNode</span><span class="o">.</span><span class="n">_direction_</span><span class="p">(</span><span class="n">vnode</span><span class="p">[:])</span>
                        <span class="k">if</span> <span class="n">vdir_inp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="s2">&quot;Output coordinate variable </span><span class="si">{!r}</span><span class="s2"> has no calculable &quot;</span>
                                    <span class="s2">&quot;direction&quot;</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="n">vdir_inp</span> <span class="o">!=</span> <span class="n">vdir_out</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_idims</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">vdesc</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Create the required dimensions in the file</span>
            <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="n">req_dims</span><span class="p">:</span>
                <span class="n">ddesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dname</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ddesc</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="p">(</span><span class="s2">&quot;Cannot create unset dimension </span><span class="si">{!r}</span><span class="s2"> in file &quot;</span> <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">dname</span><span class="p">,</span> <span class="n">fname</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">ddesc</span><span class="o">.</span><span class="n">unlimited</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">ddesc</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

            <span class="c1"># Create the variables and write their attributes</span>
            <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">.</span><span class="n">label</span>
                <span class="n">vdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
                <span class="n">vattrs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vnode</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

                <span class="n">vdtype</span> <span class="o">=</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">dtype</span>
                <span class="n">fillval</span> <span class="o">=</span> <span class="n">vattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_FillValue&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">vdims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vdesc</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">deflate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">zlib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">deflate</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">clev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">deflate</span> <span class="k">if</span> <span class="n">zlib</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deflate</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Override deflate value must be an integer&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">deflate</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">deflate</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Override deflate value range from 0 to 9&quot;</span><span class="p">)</span>
                    <span class="n">zlib</span> <span class="o">=</span> <span class="n">deflate</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">clev</span> <span class="o">=</span> <span class="n">deflate</span> <span class="k">if</span> <span class="n">zlib</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">ncvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span>
                    <span class="n">vname</span><span class="p">,</span> <span class="n">vdtype</span><span class="p">,</span> <span class="n">vdims</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">fillval</span><span class="p">,</span> <span class="n">zlib</span><span class="o">=</span><span class="n">zlib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">clev</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">vattrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">aname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwritten_attributes</span><span class="p">:</span>
                        <span class="n">avalue</span> <span class="o">=</span> <span class="n">vattrs</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">aname</span> <span class="o">==</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span>
                            <span class="n">idimstr</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">dimensions</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idims</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idimstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">avalue</span> <span class="o">=</span> <span class="s2">&quot;invdims(</span><span class="si">{}</span><span class="s2">, dims=[</span><span class="si">{}</span><span class="s2">])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">avalue</span><span class="p">,</span> <span class="n">idimstr</span>
                                <span class="p">)</span>
                        <span class="n">ncvar</span><span class="o">.</span><span class="n">setncattr</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span> <span class="n">avalue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the file associated with the WriteNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp_fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">tmp_fname</span><span class="p">):</span>
                <span class="n">rename</span><span class="p">(</span><span class="n">tmp_fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_chunk_iter_</span><span class="p">(</span><span class="n">dsizes</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dsizes</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Dimensions must be an ordered dictionary of names and sizes&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Dimension chunks must be a dictionary&quot;</span><span class="p">)</span>

        <span class="n">chunks_</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="n">chunks</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">chunks</span> <span class="k">else</span> <span class="n">dsizes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsizes</span><span class="p">}</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">d</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">dsizes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">//</span> <span class="n">chunks_</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">dsizes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">%</span> <span class="n">chunks_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsizes</span>
        <span class="p">}</span>
        <span class="n">ntotal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">nchunks</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nchunks</span><span class="p">]))</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsizes</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntotal</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">nchunks</span><span class="p">:</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nchunks</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsizes</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="n">chunks_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunks_</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="n">chunk</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="k">if</span> <span class="n">ub</span> <span class="o">&lt;</span> <span class="n">dsizes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">chunk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_invert_dims_</span><span class="p">(</span><span class="n">dsizes</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">idims</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dsizes</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Dimensions must be an ordered dictionary of names and sizes&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Chunk must be an ordered dictionary of names and slices&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idims</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Dimensions to invert must be a set&quot;</span><span class="p">)</span>

        <span class="n">ichunk</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dsizes</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">dsizes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">idims</span><span class="p">:</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="n">s</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">stop</span>
                <span class="n">ichunk</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">ub</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ub</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ichunk</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">ichunk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_direction_</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;increasing&quot;</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;decreasing&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="WriteNode.execute"><a class="viewcode-back" href="../../flownodes.html#pyconform.flownodes.WriteNode.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{},</span> <span class="n">deflate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the writing of the WriteNode file at once</span>

<span class="sd">        This method efficiently writes all of the data for each file only once, chunking</span>
<span class="sd">        the data according to the &#39;chunks&#39; parameter, as needed.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            chunks (dict): A dictionary of output dimension names and chunk sizes for each</span>
<span class="sd">                dimension given.  Output dimensions not included in the dictionary will not be</span>
<span class="sd">                chunked.  (Use OrderedDict to preserve order of dimensions, where the first</span>
<span class="sd">                dimension will be assumed to correspond to the fastest-varying index and the last</span>
<span class="sd">                dimension will be assumed to correspond to the slowest-varying index.)</span>
<span class="sd">            deflate (int): Override the output file deflate level with given value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Open the file and write the header information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_</span><span class="p">(</span><span class="n">deflate</span><span class="o">=</span><span class="n">deflate</span><span class="p">)</span>

        <span class="c1"># Create data structure to keep track of which variable chunks we have written</span>
        <span class="n">vchunks</span> <span class="o">=</span> <span class="p">{</span><span class="n">vnode</span><span class="o">.</span><span class="n">label</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">}</span>

        <span class="c1"># Compute the Global Dimension Sizes dictionary from the input variable nodes</span>
        <span class="n">inputdims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vnode</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputdims</span><span class="p">:</span>
                    <span class="n">inputdims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">gdims</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">inputdims</span><span class="p">)</span>

        <span class="c1"># Iterate over the global dimension space</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">WriteNode</span><span class="o">.</span><span class="n">_chunk_iter_</span><span class="p">(</span><span class="n">gdims</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">):</span>

            <span class="c1"># Invert the necessary dimensions to get the read-chunk</span>
            <span class="n">rchunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invert_dims_</span><span class="p">(</span><span class="n">gdims</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">idims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_idims</span><span class="p">)</span>

            <span class="c1"># Loop over all variables and write the data, if necessary</span>
            <span class="k">for</span> <span class="n">vnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="n">vname</span> <span class="o">=</span> <span class="n">vnode</span><span class="o">.</span><span class="n">label</span>
                <span class="n">vdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filedesc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
                <span class="n">ncvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>

                <span class="c1"># Compute the write-chunk for the given variable</span>
                <span class="n">wchunk</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">vdesc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>

                <span class="c1"># Write the data to the variable, if it hasn&#39;t already been</span>
                <span class="c1"># written</span>
                <span class="k">if</span> <span class="nb">repr</span><span class="p">(</span><span class="n">wchunk</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vchunks</span><span class="p">[</span><span class="n">vname</span><span class="p">]:</span>
                    <span class="n">vdata</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">[</span><span class="n">rchunk</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdata</span><span class="p">,</span> <span class="n">CharArray</span><span class="p">):</span>
                        <span class="n">vdata</span> <span class="o">=</span> <span class="n">vdata</span><span class="o">.</span><span class="n">stretch</span><span class="p">(</span><span class="n">ncvar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ncvar</span><span class="p">[</span><span class="n">wchunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">vdata</span>
                    <span class="n">vchunks</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">wchunk</span><span class="p">))</span>

        <span class="c1"># Close the file after completion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017-2020, University Corporation for Atmospheric Research

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>